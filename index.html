<!DOCTYPE html>
<html lang="sk" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Cenový Alarm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #E0E0E0;
        }
        /* Štýly pre vlastný slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4A5568; /* tmavšia dráha */
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3B82F6; /* modrý bežec */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #E0E0E0;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3B82F6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #E0E0E0;
        }

        /* --- Štýly pre vertikálnu os --- */
        .price-axis-container {
            position: relative;
            width: 100%; 
            height: 550px; /* Výška osi */
            display: flex;
            justify-content: center;
            padding: 20px 0;
            margin: 0 auto;
            transition: opacity 0.3s;
            padding-left: 50px; 
            box-sizing: border-box; 
        }
        
        /* Deaktivovaná os */
        .axis-disabled {
            /* opacity: 0.4; */ 
            /* pointer-events: none; */ 
        }

        .price-axis-line {
            width: 6px;
            height: 100%;
            background-color: #4A5568;
            border-radius: 3px;
            position: relative;
            z-index: 5; /* Posunutie nad grid */
        }
        .price-dot {
            position: absolute;
            left: 50%; /* Centrovanie na os */
            transform: translateX(-50%);
            border-radius: 50%;
            z-index: 10;
            transition: bottom 0.5s ease-out;
        }
        .price-label {
            position: absolute;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem; 
            font-weight: 600;
            white-space: nowrap;
            z-index: 20;
            transition: bottom 0.5s ease-out;
        }
        
        .label-low, .label-high {
            right: 50%; 
            transform: translateX(0); 
            margin-right: 25px; /* Väčšia medzera od stredovej čiary */
            text-align: right; 
            cursor: ns-resize; 
            user-select: none; 
        }
        .label-current {
            left: 50%; 
            transform: translateX(0);
            margin-left: 25px; /* Väčšia medzera od stredovej čiary */
            text-align: left;
        }
        .axis-grid-item {
            position: absolute;
            right: 50%;
            transform: translateX(0);
            margin-right: 25px; /* Zarovnané s hlavnými štítkami */
            z-index: 1;
            transition: bottom 0.5s ease-out;
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            color: #555;
        }
        .axis-grid-label-text {
            white-space: nowrap;
            text-align: right;
            padding-right: 8px; /* Medzera od čiary */
        }
        /* Prerušovaná čiara pre grid */
        .axis-grid-item::after { 
            content: '';
            display: block;
            height: 1px;
            width: 15px; /* Dlhšia čiara */
            background-image: linear-gradient(to right, #555 60%, transparent 0%);
            background-position: bottom;
            background-size: 3px 1px; /* Vzor prerušovanej čiary */
            background-repeat: repeat-x;
        }

        /* Farby */
        .dot-current { background-color: #FBBF24; border: 2px solid #FFF; width: 16px; height: 16px; }
        .dot-low { background-color: #EF4444; border: 2px solid #FFF; width: 12px; height: 12px; }
        .dot-high { background-color: #22C55E; border: 2px solid #FFF; width: 12px; height: 12px; }
        
        .label-current { background-color: #FBBF24; color: #1F2937; }
        .label-low { background-color: #EF4444; color: #FFF; }
        .label-high { background-color: #22C55E; color: #1F2937; }

        /* Sivé a zablokované API v zozname */
        select option.api-disabled {
            color: #777;
            background-color: #333;
        }
        /* Žurnál s horizontálnym posúvaním */
        #save-journal {
            overflow-y: auto;
            overflow-x: auto; /* Pridané pre posúvanie */
            white-space: nowrap; /* Donúti riadky zostať v jednom riadku */
        }
        #save-journal > div {
            white-space: nowrap; /* Aplikované aj na deti */
        }

        /* Štýl pre prepínač (Toggle) */
        .toggle-bg {
            display: inline-block;
            position: relative;
            width: 50px;
            height: 28px;
            background-color: #4A5568; /* Vypnuté pozadie */
            border-radius: 9999px;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .toggle-dot {
            display: block;
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s ease-in-out;
        }
        .toggle-bg.toggled {
            background-color: #22C55E; /* Zapnuté pozadie (zelená) */
        }
        .toggle-bg.toggled .toggle-dot {
            transform: translateX(22px);
        }
        
        /* Slovenský formát pre input[type=number] */
        .locale-format {
            text-align: right;
        }

        /* --- NOVÉ: Štýly pre Obľúbené --- */
        #favorites-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .favorite-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background-color: #374151; /* gray-700 */
            color: #D1D5DB; /* gray-300 */
            padding: 10px 12px;
            border-radius: 8px; 
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 6px;
        }
        .favorite-btn:hover {
            background-color: #4B5563; /* gray-600 */
            color: #FFF;
        }
        /* Aktívna obľúbená položka */
        .favorite-btn.active {
            background-color: #3B82F6; /* blue-600 */
            color: #FFF;
            font-weight: 600;
        }
        
        .favorite-remove-btn {
            padding: 2px;
            border-radius: 50%;
            color: #9CA3AF; /* gray-400 */
            opacity: 0.5;
        }
        .favorite-remove-btn:hover {
            background-color: #EF4444; /* red-500 */
            color: #FFF;
            opacity: 1;
        }
        .favorite-btn.active .favorite-remove-btn {
            color: #DFEFFF;
        }
        
        /* NOVÝ DIZAJN TLAČIDLA PRIDAŤ */
        #add-favorite-btn {
            width: 100%;
            padding: 8px 10px;
            background-color: #16A34A; /* green-600 */
            color: #FFF;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
            font-weight: 500;
            font-size: 0.875rem;
        }
        #add-favorite-btn:hover {
            background-color: #15803D; /* green-700 */
        }

        /* OPRAVA v10.13: Placeholder je teraz veľmi tmavý (slabo viditeľný) */
        #favorite-symbol-input::-webkit-input-placeholder,
        #low-threshold::-webkit-input-placeholder,
        #high-threshold::-webkit-input-placeholder {
            color: #1F2937; /* gray-800 */
            opacity: 1;
        }
        #favorite-symbol-input::-moz-placeholder,
        #low-threshold::-moz-placeholder,
        #high-threshold::-moz-placeholder {
            color: #1F2937; /* gray-800 */
            opacity: 1;
        }
        #favorite-symbol-input:-ms-input-placeholder,
        #low-threshold:-ms-input-placeholder,
        #high-threshold:-ms-input-placeholder {
            color: #1F2937; /* gray-800 */
            opacity: 1;
        }
        #favorite-symbol-input::-ms-input-placeholder,
        #low-threshold::-ms-input-placeholder,
        #high-threshold::-ms-input-placeholder {
            color: #1F2937; /* gray-800 */
            opacity: 1;
        }
        #favorite-symbol-input::placeholder,
        #low-threshold::placeholder,
        #high-threshold::placeholder {
            color: #1F2937; /* gray-800 */
            opacity: 1;
        }

        /* ZMENA NÁZVU TLAČIDLA RESET */
        #hard-reset-button span {
            /* Text sa mení dynamicky cez JS */
        }
    </style>
</head>
<body class="h-full p-4 md:p-8 bg-gray-900 text-gray-200">

    <div class="max-w-7xl mx-auto">
        <!-- Hlavný grid: ZMENA ROZLOŽENIA (5/12 Graf | 3/12 Obľúbené | 4/12 Nastavenia) -->
        <div class="flex flex-col md:flex-row md:space-x-8">

            <!-- 1. Stĺpec: Vertikálny graf (OPRAVA ŠÍRKY: 5/12) -->
            <div class="md:w-5/12 mb-6 md:mb-0">
                <div class="bg-gray-800 shadow-xl rounded-lg p-4 sticky top-8">
                    <!-- Hlavička grafu - UPRAVENÁ v10.14 -->
                    <div class="flex justify-between items-center mb-4">
                        
                        <!-- 1. Vľavo: Názov -->
                        <div class="flex items-center space-x-2">
                           <h2 class="text-xl font-bold text-white">Cenová Os</h2>
                        </div>

                        <!-- 2. V strede: Tlačidlá (PRESNUTÉ SEM) -->
                        <div class="flex items-center justify-center space-x-4">
                            <!-- Tlačidlo Recentrovať -->
                            <button id="recenter-button" 
                                    class="flex items-center space-x-1.5 py-1.5 px-3 bg-blue-600/20 text-blue-300 rounded-md hover:bg-blue-600/40 hover:text-blue-200 transition-all duration-150" 
                                    title="Recentrovať graf (zobraziť uložené hranice)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7V9a1 1 0 01-2 0V3a1 1 0 011-1zm.004 10a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13V11a1 1 0 112 0v6a1 1 0 01-1 1h-6a1 1 0 110-2h2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.004-1.334z" clip-rule="evenodd" />
                                </svg>
                                <span class="text-xs font-medium">Recentrovať</span>
                            </button>
                            
                            <!-- Tlačidlo Hard Reset -->
                            <button id="hard-reset-button" 
                                    class="flex items-center space-x-1.5 py-1.5 px-3 bg-yellow-600/20 text-yellow-300 rounded-md hover:bg-yellow-600/40 hover:text-yellow-200 transition-all duration-150" 
                                    title="Hard Reset: Vypočítať a uložiť nové dynamické hranice">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                    <path fill-rule="evenodd" d="M9 10a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 9 10Z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M8.25 10a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5A.75.75 0 0 1 8.25 10Z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M9 10a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01A.75.75 0 0 1 9 10Z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm-5.75-8a.75.75 0 0 0 0 1.5h.01a.75.75 0 0 0 0-1.5h-.01ZM10 4.25a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-1.5 0v-.01a.75.75 0 0 1 .75-.75ZM10 15.75a.75.75 0 0 1 .75-.75v-.01a.75.75 0 0 1-1.5 0v.01a.75.75 0 0 1 .75.75ZM15.75 10a.75.75 0 0 0 0-1.5h-.01a.75.75 0 0 0 0 1.5h.01Z" clip-rule="evenodd" />
                                </svg>
                                <!-- ZMENA: Text sa nastavuje cez JS -->
                                <span id="hard-reset-button-text" class="text-xs font-medium">Reset 0.1%</span>
                            </button>
                        </div>

                        <!-- 3. Vpravo: Status -->
                        <div class="flex items-center space-x-2">
                            <!-- Countdown Timer -->
                            <span id="countdown-timer" class="text-xs text-gray-400 font-mono">--s</span>
                            <!-- Status Indicator -->
                            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-500" title="Pripájam sa..."></div>
                        </div>
                    </div>
                    
                    <!-- Vertikálna os -->
                    <div id="price-axis-wrapper" class="price-axis-container">
                        <!-- Sivé orientačné čiary (grid) -->
                        <div id="axis-grid-lines" class="absolute top-0 left-0 w-full h-full z-1"></div>
                        
                        <div class="price-axis-line">
                            <!-- LOW bodka a štítok -->
                            <div id="low-dot" class="price-dot dot-low" style="bottom: 10%;"></div>
                            <div id="low-label" class="price-label label-low" style="bottom: 10%;">LOW: 0</div>
                            
                            <!-- HIGH bodka a štítok -->
                            <div id="high-dot" class="price-dot dot-high" style="bottom: 90%;"></div>
                            <div id="high-label" class="price-label label-high" style="bottom: 90%;">HIGH: 0</div>
                            
                            <!-- CURRENT bodka a štítok -->
                            <div id="current-dot" class="price-dot dot-current" style="bottom: 50%;"></div>
                            <div id="current-label" class="price-label label-current" style="bottom: 50%;">CENA: 0</div>
                        </div>
                        
                    </div>

                    <!-- Info o aktuálnej cene -->
                    <div class="text-center mt-4">
                        <span class="text-xs text-gray-400" id="api-source-display">Zdroj: Načítavam...</span>
                        <div id="price-display" class="text-3xl font-bold text-white mt-1">...</div>
                    </div>
                </div>
            </div>

            <!-- 2. Stĺpec: NOVÝ OBĽÚBENÉ (3/12) -->
            <div class="md:w-3/12 mb-6 md:mb-0">
                <div class="bg-gray-800 shadow-xl rounded-lg p-4 sticky top-8">
                      <h2 class="text-xl font-bold text-white mb-4">Obľúbené</h2>
                      <!-- Pridanie coinu -->
                      <div class="mb-6">
                        <label for="favorite-symbol-input" class="block text-sm font-medium text-gray-300 mb-2">Pridať Coin</label>
                        <input type="text" id="favorite-symbol-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 mb-2" placeholder="napr. ETHUSDT">
                        <button id="add-favorite-btn" title="Pridať do obľúbených">
                            + Pridať do obľúbených
                        </button>
                      </div>
                      <!-- Zoznam -->
                      <div id="favorites-list" class="space-y-2">
                          <!-- Obľúbené tlačidlá sa pridajú sem -->
                      </div>
                </div>
            </div>

            <!-- 3. Stĺpec: Nastavenia (OPRAVA ŠÍRKY: 4/12) -->
            <div class="md:w-4/12">
                <div class="bg-gray-800 shadow-xl rounded-lg p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">Nastavenia</h2>

                    <!-- Riadok 1: API -->
                    <div class="mb-6">
                        <label for="api-source" class="block text-sm font-medium text-gray-300 mb-2">Zdroj údajov (API)</label>
                        <select id="api-source" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <optgroup label="Perp / Swapy">
                                <option value="bybit-perp-linear" selected>Bybit USDT Perp (linear)</option>
                                <option value="bybit-perp-inverse">Bybit Inverse Perp (USD)</option>
                                <option value="okx-swap">OKX SWAP (USDT-settlement)</option>
                                <option value="deribit-perp">Deribit Perpetual (USD)</option>
                                <option value="bitmex-perp">BitMEX Perpetual (XBTUSD)</option>
                                <option value="bitget-perp">Bitget USDT Perp</option>
                                <option value="gate-perp-usdt">Gate.io USDT Perp</option>
                                <option value="binance-fapi" disabled class="api-disabled">Binance USDⓈ-M Futures (CORS)</option>
                                <option value="binance-dapi" disabled class="api-disabled">Binance COIN-M Futures (CORS)</option>
                                <option value="kraken-futures" disabled class="api-disabled">Kraken Futures (CORS)</option>
                            </optgroup>
                            <optgroup label="Spot">
                                <option value="binance-spot">Binance Spot</option>
                                <option value="okx-spot">OKX Spot</option>
                                <option value="kucoin-spot">KuCoin Spot</option>
                                <option value="bybit-spot">Bybit Spot</option>
                                <option value="mexc-spot">MEXC Spot</option>
                                <option value="gate-spot">Gate.io Spot</option>
                                <option value="bitfinex-spot">Bitfinex Spot</option>
                                <option value="kraken-spot">Kraken Spot</option>
                                <option value="huobi-spot">HTX / Huobi Spot</option>
                                <option value="bitstamp-spot">Bitstamp Spot</option>
                                <option value="coinbase-spot">Coinbase Spot</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Riadok 2: Interval -->
                    <div class="mb-6">
                        <label for="interval-slider" class="block text-sm font-medium text-gray-300 mb-2">Interval (sek.)</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="interval-slider" min="2" max="60" value="10" class="w-full">
                            <span id="interval-value" class="font-mono text-lg text-white w-10 text-right">10s</span>
                        </div>
                    </div>
                    
                    <!-- Riadok 3: Manuálne nastavenie -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="low-threshold" class="block text-sm font-medium text-gray-300 mb-2">Dolná Hranica (Low) <span class="text-red-400">*</span></label>
                            <input type="text" id="low-threshold" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 locale-format" placeholder="Min. 0,01">
                        </div>
                        <div>
                            <label for="high-threshold" class="block text-sm font-medium text-gray-300 mb-2">Horná Hranica (High) <span class="text-green-400">*</span></label>
                            <input type="text" id="high-threshold" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 locale-format" placeholder="napr. 70 000,00">
                        </div>
                    </div>

                    <!-- Riadok 4: Tlačidlo Uložiť (Oddelené) -->
                    <div class="mb-6">
                        <button id="save-button" class="w-full bg-green-600 text-white py-3 px-6 rounded-md text-lg font-semibold hover:bg-green-700 transition duration-150 shadow-lg">
                            Uložiť Hranice
                        </button>
                    </div>
                    
                    <!-- Riadok 5: Prepínače Alarmov (NOVÉ PREHĽADNÉ ROZLOŽENIE) -->
                    <div class="space-y-5">
                        
                        <!-- Riadok 5.1: Master Alarm -->
                        <div class="flex items-center justify-between rounded-lg bg-gray-700/50 p-4 border border-gray-600">
                            <div>
                                <label for="master-alarm-toggle" class="block text-sm font-semibold text-red-400 whitespace-nowrap">VŠETKY ALARMY</label>
                                <span class="text-xs text-gray-400">Hlavný vypínač pre celú aplikáciu</span>
                            </div>
                            <button type="button" id="master-alarm-toggle" class="toggle-bg toggled" role="switch" aria-checked="true">
                                <span class="sr-only">Všetky Alarmy</span>
                                <span aria-hidden="true" class="toggle-dot"></span>
                            </button>
                        </div>

                        <!-- Riadok 5.2: Alarmy pre Coin -->
                        <div class="rounded-lg bg-gray-700/50 p-4 border border-gray-600">
                            <h4 class="text-sm font-semibold text-gray-200 mb-4">Nastavenia pre aktuálny coin</h4>
                            <div class="space-y-4">
                                <!-- Alarm Aktívny -->
                                <div class="flex items-center justify-between">
                                    <label for="alarm-enabled-toggle" class="block text-sm font-medium text-gray-300 whitespace-nowrap">Alarm Aktívny</label>
                                    <button type="button" id="alarm-enabled-toggle" class="toggle-bg toggled" role="switch" aria-checked="true">
                                        <span class="sr-only">Alarm Aktívny</span>
                                        <span aria-hidden="true" class="toggle-dot"></span>
                                    </button>
                                </div>
                                <!-- Zvuk Alarmu -->
                                <div class="flex items-center justify-between">
                                    <label for="alarm-sound-toggle" class="block text-sm font-medium text-gray-300 whitespace-nowrap">Zvuk Alarmu</label>
                                    <button type="button" id="alarm-sound-toggle" class="toggle-bg toggled" role="switch" aria-checked="true">
                                        <span class="sr-only">Zvuk Alarmu</span>
                                        <span aria-hidden="true" class="toggle-dot"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <!-- NOVÁ SEKCIA: Žurnál Uloženia (pod stĺpcami) -->
        <div class="mt-8">
             <div class="bg-gray-800 shadow-xl rounded-lg p-6">
                 <h3 class="text-lg font-semibold text-white mb-4">Žurnál Uloženia</h3>
                <div id="save-journal" class="h-40 bg-gray-900 rounded-md p-3 text-xs font-mono border border-gray-700">
                    <!-- Záznamy sa pridajú sem -->
                </div>
             </div>
        </div>
    </div>

    <!-- Modál pre Alarm -->
    <div id="alarm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full mx-4 border-2 border-red-500 animate-pulse">
            <h2 class="text-3xl font-bold text-red-400 mb-4 text-center">!!! ALARM !!!</h2>
            <p id="alarm-message" class="text-lg text-white text-center mb-6">Cena prekročila tvoj limit!</p>
            <button onclick="dismissAlarm()" class="w-full bg-red-600 text-white py-3 px-6 rounded-md text-lg font-semibold hover:bg-red-700 transition duration-150">
                Zastaviť Alarm
            </button>
        </div>
    </div>

    <!-- Firebase a Tone.js skripty -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDocs, setDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* --- Globálne premenné --- */
        let db, auth, userId, userSettingsRef, coinSettingsCollectionRef;
        let priceCheckInterval;
        let countdownInterval; 
        let currentBtcPrice = 0;
        let isAlarmActive = false;
        let isAlarmMuted = false;
        let coinSettingsListener = null; 
        let currentIntervalSeconds = 10; 
        let secondsRemaining = 10; 
        
        let globalSettings = {
            isMasterAlarmEnabled: true,
            apiSource: 'bybit-perp-linear',
            intervalSeconds: 10
        };
        let currentCoinSymbol = 'BTCUSDT'; /* Aktívne zvolený coin */
        let favorites = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
        let allCoinSettings = {}; /* Mapa pre ukladanie LOW/HIGH pre každý coin */
        let isInitialLoad = true; 
        let firstSuccessfulFetch = false; 

        /* --- Premenné pre Drag & Drop a Grid --- */
        let isDragging = null; /* 'low' or 'high' */
        let axisRect, axisMin, axisMax, axisRange; /* Pre D&D a grid */
        let forceProportionalUpdate = false; /* Pre Recentrovanie */
        const MIN_PRICE = 0.000001; /* Minimálna cena (proti bankrotu) */

        /* --- Synth pre Tone.js --- */
        let alarmSynth;

        /* --- Elementy --- */
        const priceDisplay = document.getElementById('price-display');
        const statusIndicator = document.getElementById('status-indicator');
        const lowThresholdInput = document.getElementById('low-threshold');
        const highThresholdInput = document.getElementById('high-threshold');
        const saveButton = document.getElementById('save-button');
        const alarmModal = document.getElementById('alarm-modal');
        const alarmMessage = document.getElementById('alarm-message');
        const apiSourceSelect = document.getElementById('api-source');
        const coinSymbolInput = document.getElementById('favorite-symbol-input');
        const apiSourceDisplay = document.getElementById('api-source-display');
        const intervalSlider = document.getElementById('interval-slider');
        const intervalValue = document.getElementById('interval-value');
        const countdownTimer = document.getElementById('countdown-timer');
        const gridLinesContainer = document.getElementById('axis-grid-lines'); 
        const saveJournal = document.getElementById('save-journal'); 
        const alarmEnabledToggle = document.getElementById('alarm-enabled-toggle');
        const alarmSoundToggle = document.getElementById('alarm-sound-toggle'); 
        const masterAlarmToggle = document.getElementById('master-alarm-toggle');
        const priceAxisWrapper = document.getElementById('price-axis-wrapper'); 
        const recenterButton = document.getElementById('recenter-button'); 
        const hardResetButton = document.getElementById('hard-reset-button');
        const hardResetButtonText = document.getElementById('hard-reset-button-text'); // NOVÝ ELEMENT
        const favoritesBar = document.getElementById('favorites-list'); 
        const addFavoriteButton = document.getElementById('add-favorite-btn');

        /* --- Formátovače Čísel (OPRAVA pre desatinné miesta) --- */
        
        const skNumberFormatter = new Intl.NumberFormat('sk-SK', {
            style: 'decimal',
            maximumFractionDigits: 8, 
        });
        
        const skDeltaFormatter = new Intl.NumberFormat('sk-SK', {
            style: 'decimal',
            maximumFractionDigits: 8,
        });
        
        /* --- Formátovanie cien --- */
        function parseLocaleNumber(stringNumber) {
            if (typeof stringNumber !== 'string') return parseFloat(stringNumber);
            const sanitized = stringNumber.replace(/\s/g, '').replace(',', '.');
            return parseFloat(sanitized);
        }

        function formatSkNumber(price) {
            const safePrice = Math.max(0, price);
            return skNumberFormatter.format(safePrice);
        }
        
        /* Zápis do žurnálu */
        function logToJournal(message) {
            if (!saveJournal) return;
            const timestamp = new Date().toLocaleTimeString('sk-SK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1'; 
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> <span class="text-gray-200">${message}</span>`;
            
            saveJournal.insertBefore(logEntry, saveJournal.firstChild);
        }

        /* --- NOVÁ FUNKCIA: Dynamický Spread --- */
        /**
         * Vracia dynamický spread (napr. 0.001 pre 0.1%) na základe ceny coinu.
         * @param {number} price - Aktuálna cena coinu.
         * @returns {number} - Hodnota spreadu (napr. 0.01 pre 1%).
         */
        function getDynamicSpread(price) {
            if (price > 1000) {
                return 0.0025; // 0.25% pre ceny > $1000 (napr. BTC)
            } else if (price > 1) {
                return 0.01; // 1.0% pre ceny > $1 (napr. SOL)
            } else {
                return 0.025; // 2.5% pre ceny <= $1 (napr. SAND)
            }
        }
        
        /**
         * Aktualizuje text na tlačidle "Reset" podľa aktuálneho dynamického spreadu.
         */
        function updateResetButtonText() {
            if (currentBtcPrice > 0) {
                const spread = getDynamicSpread(currentBtcPrice);
                const percentText = (spread * 100).toFixed(1);
                hardResetButtonText.textContent = `Reset ${percentText}%`;
            } else {
                hardResetButtonText.textContent = `Reset ...%`;
            }
        }

        /* --- Inicializácia Firebase --- */
        async function initialize() {
            try {
                alarmSynth = new Tone.MembraneSynth().toDestination();

                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    console.warn("Firebase config chýba. Aplikácia pobeží v lokálnom režime.");
                    updateMonitoringStatus('offline');
                    loadGlobalSettings(); /* Načítaj lokálne (aj keď len predvolené) */
                    startMonitoring();
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                /* Prihlásenie používateľa */
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const docPath = `artifacts/${appId}/users/${userId}/btcAlarmSettings/userSettings`;
                        userSettingsRef = doc(db, docPath);
                        
                        coinSettingsCollectionRef = collection(db, userSettingsRef.path, 'coinSettings');
                        
                        listenForSettings();
                        listenToCoinSettings();
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Chyba prihlásenia:", authError);
                            updateMonitoringStatus('offline');
                            loadGlobalSettings();
                            startMonitoring();
                        }
                    }
                });
            } catch (e) {
                console.error("Chyba inicializácie Firebase:", e);
                updateMonitoringStatus('offline');
                loadGlobalSettings();
                startMonitoring();
            }
        }

        /* --- Spracovanie Nastavení (Firestore) --- */
        
        function loadGlobalSettings(settings = {}) {
            globalSettings.apiSource = settings.apiSource || 'bybit-perp-linear';
            globalSettings.intervalSeconds = settings.intervalSeconds || 10;
            globalSettings.isMasterAlarmEnabled = (settings.isMasterAlarmEnabled === false) ? false : true; 
            
            apiSourceSelect.value = globalSettings.apiSource;
            intervalSlider.value = globalSettings.intervalSeconds;
            intervalValue.textContent = `${globalSettings.intervalSeconds}s`;

            favorites = settings.favorites || ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
            allCoinSettings = settings.coinSettings || allCoinSettings; 
            currentCoinSymbol = settings.lastUsedCoin || 'BTCUSDT';

            applyCurrentCoinSettings(false);
            
            renderFavorites();
            updateMasterAlarmStatus(false);
        }

        function applyCurrentCoinSettings(isNewCoin = false) {
            const symbol = currentCoinSymbol;
            const settings = allCoinSettings[symbol];

            let coinSpecificAlarmEnabled = false;
            let coinSpecificSoundEnabled = false;

            if (settings) {
                lowThresholdInput.value = formatSkNumber(settings.low || 0);
                highThresholdInput.value = formatSkNumber(settings.high || 0);
                
                if(settings.low > 0) {
                   firstSuccessfulFetch = true;
                } else {
                   firstSuccessfulFetch = false;
                }
                
                coinSpecificAlarmEnabled = settings.isAlarmSystemEnabled || false;
                coinSpecificSoundEnabled = settings.isAlarmSoundEnabled || false;

            } else {
                lowThresholdInput.value = '';
                highThresholdInput.value = '';
                firstSuccessfulFetch = false;
            }
            
            updateAlarmSystemStatus(false, coinSpecificAlarmEnabled);
            updateAlarmSoundStatus(false, coinSpecificSoundEnabled);

            // Pri zmene coinu resetuj aj text tlačidla reset
            updateResetButtonText();

            if (isNewCoin) {
                currentBtcPrice = 0;
                updatePriceAxis(0, 0, 0, false);
                startMonitoring();
            }
        }

        function listenForSettings() {
            if (!userSettingsRef) {
                loadGlobalSettings();
                applyCurrentCoinSettings(true);
                isInitialLoad = false;
                return;
            }

            onSnapshot(userSettingsRef, (docSnap) => {
                let settings = {};
                if (docSnap.exists()) {
                    settings = docSnap.data();
                }
                
                loadGlobalSettings(settings);
                
                if (isInitialLoad) {
                    startMonitoring();
                    isInitialLoad = false;
                }

            }, (error) => {
                console.error("Chyba pri počúvaní globálnych nastavení:", error);
                loadGlobalSettings();
                if (isInitialLoad) {
                    applyCurrentCoinSettings(true);
                    isInitialLoad = false;
                }
            });
        }

        function listenToCoinSettings() {
            if (coinSettingsListener) coinSettingsListener();
            
            if (!coinSettingsCollectionRef) {
                 console.warn("Referencia na kolekciu coinov chýba");
                 return;
            }

            coinSettingsListener = onSnapshot(query(coinSettingsCollectionRef), (querySnapshot) => {
                let settingsChangedForCurrentCoin = false;
                
                allCoinSettings = {};
                querySnapshot.forEach((doc) => {
                    allCoinSettings[doc.id] = doc.data();
                });

                if(isInitialLoad) {
                    applyCurrentCoinSettings(false);
                } else {
                    querySnapshot.docChanges().forEach((change) => {
                        const symbol = change.doc.id;
                        if (symbol === currentCoinSymbol) {
                            settingsChangedForCurrentCoin = true;
                        }
                    });
                }
                
                if (settingsChangedForCurrentCoin && !isInitialLoad) {
                    applyCurrentCoinSettings(false);
                    updatePriceAxis(currentBtcPrice, 
                        parseLocaleNumber(lowThresholdInput.value), 
                        parseLocaleNumber(highThresholdInput.value)
                    );
                }
            }, (error) => {
                console.error("Chyba pri počúvaní nastavení coinov:", error);
            });
        }

        async function saveGlobalSettingsOnly() {
            if (!userSettingsRef) return; 

            globalSettings.apiSource = apiSourceSelect.value;
            globalSettings.intervalSeconds = parseInt(intervalSlider.value);
            
            const globalSettingsToSave = {
                apiSource: globalSettings.apiSource,
                lastUsedCoin: currentCoinSymbol,
                intervalSeconds: globalSettings.intervalSeconds,
                isMasterAlarmEnabled: globalSettings.isMasterAlarmEnabled,
                favorites: favorites,
            };

            try {
                await setDoc(userSettingsRef, globalSettingsToSave, { merge: true });
            } catch (e) {
                console.error("Chyba pri ukladaní globálnych nastavení:", e);
            }
        }

        async function saveSettings(fromDrag = false) {
            
            globalSettings.apiSource = apiSourceSelect.value;
            globalSettings.intervalSeconds = parseInt(intervalSlider.value);
            
            let coinSettingsToSave = null; 
            let triggerRecalc = false;
            
            const symbolToSave = currentCoinSymbol; 

            const currentAlarmEnabled = allCoinSettings[symbolToSave]?.isAlarmSystemEnabled || false;
            const currentSoundEnabled = allCoinSettings[symbolToSave]?.isAlarmSoundEnabled || false;

            if (fromDrag) { 
                const lowVal = Math.max(MIN_PRICE, parseLocaleNumber(lowThresholdInput.value) || 0);
                const highVal = parseLocaleNumber(highThresholdInput.value) || 0;
                coinSettingsToSave = { 
                    low: lowVal, 
                    high: highVal,
                    isAlarmSystemEnabled: currentAlarmEnabled,
                    isAlarmSoundEnabled: currentSoundEnabled
                };
                allCoinSettings[symbolToSave] = coinSettingsToSave;
            
            } else { 
                const lowVal = parseLocaleNumber(lowThresholdInput.value) || 0;
                const highVal = parseLocaleNumber(highThresholdInput.value) || 0;

                if (lowVal > MIN_PRICE && highVal > lowVal) {
                    coinSettingsToSave = { 
                        low: lowVal, 
                        high: highVal,
                        isAlarmSystemEnabled: currentAlarmEnabled,
                        isAlarmSoundEnabled: currentSoundEnabled
                    };
                    allCoinSettings[symbolToSave] = coinSettingsToSave;
                } else {
                    triggerRecalc = true;
                    coinSettingsToSave = { 
                        low: 0, 
                        high: 0,
                        isAlarmSystemEnabled: currentAlarmEnabled,
                        isAlarmSoundEnabled: currentSoundEnabled
                    }; 
                    allCoinSettings[symbolToSave] = coinSettingsToSave; 
                }
            }

            const globalSettingsToSave = {
                apiSource: globalSettings.apiSource,
                lastUsedCoin: symbolToSave,
                intervalSeconds: globalSettings.intervalSeconds,
                isMasterAlarmEnabled: globalSettings.isMasterAlarmEnabled,
                favorites: favorites,
            };

            if (coinSettingsToSave) {
                const apiText = apiSourceSelect.options[apiSourceSelect.selectedIndex].text;
                const btcPriceLog = currentBtcPrice > 0 ? ` | Cena: ${formatSkNumber(currentBtcPrice)}` : '';
                
                if (triggerRecalc) {
                     logToJournal(`Spustené prepočítanie limitov pre ${symbolToSave}... (API: ${apiText} | Interval: ${globalSettings.intervalSeconds}s)`);
                } else {
                    if (!fromDrag || (coinSettingsToSave.low > MIN_PRICE)) {
                        const logMessage = `Uložené: ${symbolToSave} | LOW ${formatSkNumber(coinSettingsToSave.low)} | HIGH ${formatSkNumber(coinSettingsToSave.high)}${btcPriceLog} | Zdroj: ${apiText} | Interval: ${globalSettings.intervalSeconds}s`;
                        logToJournal(logMessage);
                    }
                }

                if (userSettingsRef && coinSettingsCollectionRef) {
                    try {
                        const currentCoinDocRef = doc(coinSettingsCollectionRef, symbolToSave);
                        await setDoc(currentCoinDocRef, coinSettingsToSave, { merge: true });
                    } catch (e) {
                        console.error("Chyba pri ukladaní nastavení coinu:", e);
                    }
                }
            } 

            if (userSettingsRef) {
                try {
                    await setDoc(userSettingsRef, globalSettingsToSave, { merge: true });
                } catch (e) {
                    console.error("Chyba pri ukladaní globálnych nastavení:", e);
                }
            }
            
            if (!fromDrag) {
                currentBtcPrice = 0; 
                firstSuccessfulFetch = false; 
                applyCurrentCoinSettings(true);
            }
        }


        /* --- Zvuk Alarmu (Tone.js) --- */
        function initializeAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                     console.log("Audio kontext spustený.");
                }).catch(e => {
                    console.warn("Audio kontext sa nepodarilo spustiť:", e);
                });
            }
        }

        /* --- Funkcie pre Obľúbené --- */

        function renderFavorites() {
            favoritesBar.innerHTML = '';
            favorites.forEach(symbol => {
                const btn = document.createElement('button');
                btn.className = 'favorite-btn';
                btn.dataset.action = "select";
                btn.dataset.symbol = symbol;
                
                if (symbol === currentCoinSymbol) {
                    btn.classList.add('active');
                }

                const nameSpan = document.createElement('span');
                nameSpan.textContent = symbol;
                nameSpan.dataset.action = "select";
                nameSpan.dataset.symbol = symbol;
                
                const removeSpan = document.createElement('span');
                removeSpan.dataset.action = "remove";
                removeSpan.dataset.symbol = symbol;
                removeSpan.className = 'favorite-remove-btn';
                removeSpan.title = 'Odstrániť';
                removeSpan.innerHTML = `<svg class="w-3 h-3 pointer-events-none" fill="currentColor" viewBox="0 0 20 20"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"></path></svg>`;

                btn.appendChild(nameSpan);
                btn.appendChild(removeSpan);
                favoritesBar.appendChild(btn);
            });
        }

        favoritesBar.addEventListener('click', (e) => {
            const targetElement = e.target.closest('[data-action]');
            if (!targetElement) return;

            const action = targetElement.dataset.action;
            const symbol = targetElement.dataset.symbol;

            if (!action || !symbol) return;
            
            if (action === 'select' && symbol === currentCoinSymbol) return;

            if (action === 'select') {
                selectFavorite(symbol);
            } else if (action === 'remove') {
                removeFavorite(symbol);
            }
        });

        function selectFavorite(symbol) {
            globalSettings.intervalSeconds = parseInt(intervalSlider.value);
            globalSettings.apiSource = apiSourceSelect.value;
            
            currentCoinSymbol = symbol; 
            
            renderFavorites(); 
            
            applyCurrentCoinSettings(true); 

            saveGlobalSettingsOnly(); 
        }

        function removeFavorite(symbol) {
            favorites = favorites.filter(f => f !== symbol);
            
            if (currentCoinSymbol === symbol) {
                 coinSymbolInput.value = 'BTCUSDT';
                 currentCoinSymbol = 'BTCUSDT';
                 applyCurrentCoinSettings(false);
            }
            
            renderFavorites();
            saveGlobalSettingsOnly();
        }

        function addFavorite() {
            const newSymbol = coinSymbolInput.value.toUpperCase().trim();
            if (newSymbol && !favorites.includes(newSymbol)) {
                favorites.push(newSymbol);
                coinSymbolInput.value = ''; 
                selectFavorite(newSymbol); 
            }
        }
        /* --- Koniec Obľúbených --- */


        const alarmLoop = new Tone.Loop(time => {
            const currentCoinSoundEnabled = allCoinSettings[currentCoinSymbol]?.isAlarmSoundEnabled || false;

            if (isAlarmActive && currentCoinSoundEnabled && alarmSynth) {
                alarmSynth.triggerAttackRelease("C5", "8n", time);
                alarmSynth.triggerAttackRelease("G4", "8n", time + 0.25);
            }
        }, "0.5s");

        function playAlarmSound() {
            if (isAlarmActive) {
                if (Tone.context.state !== 'running') {
                    console.warn("Audio kontext nie je spustený! Zvuk nebude hrať.");
                    return; 
                }
                
                const currentCoinSoundEnabled = allCoinSettings[currentCoinSymbol]?.isAlarmSoundEnabled || false;
                if (!currentCoinSoundEnabled) return;

                Tone.Transport.start();
                alarmLoop.start(0);
            }
        }

        function stopAlarmSound() {
            alarmLoop.stop(0);
            Tone.Transport.stop();
        }

        /* --- Načítanie Ceny (Multi-API v3 - Dynamický Coin) --- */
        async function fetchBitcoinPrice() {
            const source = globalSettings.apiSource;
            let symbol = currentCoinSymbol;
            let apiSymbol = symbol;
            
            let url = '';
            let price = 0;
            let original_url = '';
            let response, textData;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 12000); /* 12s timeout */
            const options = { signal: controller.signal };

            // Posledná oprava proxy: Použijeme https://cors.eu.org/
            const PROXY_PREFIX = 'https://cors.eu.org/';

            try {
                let data;

                switch (source) {
                    /* --- Perp / Swapy --- */
                    case 'bybit-perp-linear':
                        apiSymbol = symbol; /* Formát: BTCUSDT */
                        original_url = `https://api.bybit.com/v5/market/tickers?category=linear&symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.result || !data.result.list || !data.result.list[0]) throw new Error("Neplatná odpoveď Bybit Perp Linear");
                        price = parseFloat(data.result.list[0].lastPrice);
                        break;
                    case 'bybit-perp-inverse':
                        apiSymbol = symbol.endsWith('USD') ? symbol : `${symbol}USD`; /* Formát: BTCUSD */
                        original_url = `https://api.bybit.com/v5/market/tickers?category=inverse&symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.result || !data.result.list || !data.result.list[0]) throw new Error("Neplatná odpoveď Bybit Perp Inverse");
                        price = parseFloat(data.result.list[0].lastPrice);
                        break;
                    case 'okx-swap':
                        apiSymbol = symbol.includes('-') ? symbol : `${symbol.replace('USDT', '')}-USDT-SWAP`; /* Formát: BTC-USDT-SWAP */
                        original_url = `https://www.okx.com/api/v5/market/ticker?instId=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.data || !data.data[0] || !data.data[0].last) throw new Error("Neplatná odpoveď OKX SWAP");
                        price = parseFloat(data.data[0].last);
                        break;
                    case 'deribit-perp':
                        apiSymbol = symbol.includes('-') ? symbol : `${symbol.replace('USD', '')}-PERPETUAL`; /* Formát: BTC-PERPETUAL */
                        original_url = `https://www.deribit.com/api/v2/public/ticker?instrument_name=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.result || !data.result.last_price) throw new Error("Neplatná odpoveď Deribit");
                        price = parseFloat(data.result.last_price);
                        break;
                    case 'bitmex-perp':
                        apiSymbol = symbol.replace('USDT', 'USD'); /* Formát: XBTUSD */
                        if (apiSymbol === 'BTCUSD') apiSymbol = 'XBTUSD';
                        original_url = `https://www.bitmex.com/api/v1/instrument?symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data[0] || !data[0].lastPrice) throw new Error("Neplatná odpoveď BitMEX");
                        price = parseFloat(data[0].lastPrice);
                        break;
                    case 'bitget-perp':
                        apiSymbol = symbol; /* Formát: BTCUSDT */
                        original_url = `https://api.bitget.com/api/v2/mix/market/ticker?productType=usdt-futures&symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.data || !data.data[0] || !data.data[0].lastPrice) throw new Error("Neplatná odpoveď Bitget");
                        price = parseFloat(data.data[0].lastPrice);
                        break;
                    case 'gate-perp-usdt':
                        apiSymbol = symbol.includes('_') ? symbol : symbol.replace('USDT', '_USDT'); /* Formát: BTC_USDT */
                        original_url = `https://api.gateio.ws/api/v4/futures/usdt/tickers?contract=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data[0] || !data[0].last) throw new Error("Neplatná odpoveď Gate.io Perp");
                        price = parseFloat(data[0].last);
                        break;

                    /* --- Spot --- */
                    case 'binance-spot':
                        apiSymbol = symbol; /* Formát: BTCUSDT */
                        original_url = `https://api.binance.com/api/v3/ticker/price?symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.price) throw new Error("Neplatná odpoveď Binance Spot");
                        price = parseFloat(data.price);
                        break;
                    case 'okx-spot':
                        apiSymbol = symbol.includes('-') ? symbol : `${symbol.replace('USDT', '')}-USDT`; /* Formát: BTC-USDT */
                        original_url = `https://www.okx.com/api/v5/market/ticker?instId=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.data || !data.data[0] || !data.data[0].last) throw new Error("Neplatná odpoveď OKX Spot");
                        price = parseFloat(data.data[0].last);
                        break;
                    case 'kucoin-spot':
                        apiSymbol = symbol.includes('-') ? symbol : `${symbol.replace('USDT', '')}-USDT`; /* Formát: BTC-USDT */
                        original_url = `https://api.kucoin.com/api/v1/market/orderbook/level1?symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.data || !data.data.price) throw new Error("Neplatná odpoveď KuCoin Spot");
                        price = parseFloat(data.data.price);
                        break;
                    case 'bybit-spot':
                        apiSymbol = symbol; /* Formát: BTCUSDT */
                        original_url = `https://api.bybit.com/v5/market/tickers?category=spot&symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.result || !data.result.list || !data.result.list[0]) throw new Error("Neplatná odpoveď Bybit Spot");
                        price = parseFloat(data.result.list[0].lastPrice);
                        break;
                    case 'mexc-spot':
                        apiSymbol = symbol; /* Formát: BTCUSDT */
                        original_url = `https://api.mexc.com/api/v3/ticker/price?symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.price) throw new Error("Neplatná odpoveď MEXC Spot");
                        price = parseFloat(data.price);
                        break;
                    case 'gate-spot':
                        apiSymbol = symbol.includes('_') ? symbol : symbol.replace('USDT', '_USDT'); /* Formát: BTC_USDT */
                        original_url = `https://api.gateio.ws/api/v4/spot/tickers?currency_pair=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data[0] || !data[0].last) throw new Error("Neplatná odpoveď Gate.io Spot");
                        price = parseFloat(data[0].last);
                        break;
                    case 'bitfinex-spot':
                        apiSymbol = symbol.replace('USDT', 'UST'); /* Formát: tBTCUST */
                        if (!apiSymbol.startsWith('t')) apiSymbol = `t${apiSymbol}`;
                        original_url = `https://api-pub.bitfinex.com/v2/ticker/${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (Array.isArray(data) && data[0] === 'error') throw new Error(`Bitfinex API chyba: ${data[2]}`);
                        if (!Array.isArray(data) || !data[6]) throw new Error("Neplatná odpoveď Bitfinex");
                        price = parseFloat(data[6]); /* [6] je LAST_PRICE */
                        break;
                    case 'kraken-spot':
                        apiSymbol = symbol; /* Formát: XBTUSDT */
                        if (apiSymbol === 'BTCUSDT') apiSymbol = 'XBTUSDT';
                        original_url = `https://api.kraken.com/0/public/Ticker?pair=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (data.error && data.error.length > 0) throw new Error(`Kraken API chyba: ${data.error[0]}`);
                        const resultKey = Object.keys(data.result || {})[0];
                        if (!resultKey || !data.result[resultKey] || !data.result[resultKey].c) throw new Error("Neplatná odpoveď Kraken");
                        price = parseFloat(data.result[resultKey].c[0]);
                        break;
                    case 'huobi-spot':
                        apiSymbol = symbol.toLowerCase(); /* Formát: btcusdt */
                        original_url = `https://api.huobi.pro/market/detail/merged?symbol=${apiSymbol}`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (data.status === 'error') throw new Error(`Huobi API chyba: ${data['err-msg']}`);
                        if (!data.tick || !data.tick.close) throw new Error("Neplatná odpoveď Huobi");
                        price = parseFloat(data.tick.close);
                        break;
                    case 'bitstamp-spot':
                        apiSymbol = symbol.toLowerCase(); /* Formát: btcusdt */
                        original_url = `https://www.bitstamp.net/api/v2/ticker/${apiSymbol}/`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.last) throw new Error("Neplatná odpoveď Bitstamp");
                        price = parseFloat(data.last);
                        break;
                    case 'coinbase-spot':
                        apiSymbol = symbol.includes('-') ? symbol : `${symbol.replace('USD', '')}-USD`; /* Formát: BTC-USD */
                        original_url = `https://api.coinbase.com/v2/prices/${apiSymbol}/spot`;
                        url = `${PROXY_PREFIX}${original_url}`;
                        response = await fetch(url, options);
                        if (!response.ok) throw new Error(`Proxy/API error: ${response.status}`);
                        textData = await response.text();
                        data = JSON.parse(textData);
                        if (!data.data || !data.data.amount) throw new Error("Neplatná odpoveď Coinbase");
                        price = parseFloat(data.data.amount);
                        break;
                    
                    default:
                        throw new Error(`Neznámy zdroj API: ${source}`);
                }
                
                clearTimeout(timeoutId);

                if (isNaN(price) || price <= 0) {
                    throw new Error("Načítaná cena je neplatná.");
                }

                return price;

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error("Timeout: API neodpovedalo včas.");
                }
                console.error(`Chyba pri načítaní ceny z ${source} (${original_url || url}):`, error);
                if (error instanceof SyntaxError) {
                     console.error("Chybný text (nebol JSON):", textData);
                }
                throw error;
            }
        }
        
        /* --- Hlavná Logika Alarmu --- */
        async function checkPriceAndAlert() {
            try {
                const price = await fetchBitcoinPrice();
                currentBtcPrice = price;

                priceDisplay.textContent = formatSkNumber(price); 
                apiSourceDisplay.textContent = `Zdroj: ${apiSourceSelect.options[apiSourceSelect.selectedIndex].text}`;
                updateMonitoringStatus('online');
                updateResetButtonText(); // ZAVOLAJ AKTUALIZÁCIU TEXTU TLAČIDLA

                let low = parseLocaleNumber(lowThresholdInput.value) || 0;
                let high = parseLocaleNumber(highThresholdInput.value) || 0;
                
                /* --- Logika: Automatické vyplnenie (POUŽÍVA DYNAMICKÝ SPREAD) --- */
                if (!firstSuccessfulFetch && price > 0) {
                    firstSuccessfulFetch = true;
                    
                    const existingLow = parseLocaleNumber(lowThresholdInput.value) || 0;
                    const existingHigh = parseLocaleNumber(highThresholdInput.value) || 0;
                    
                    if (existingLow <= 0 || existingHigh <= 0) {
                        
                        // ZÍSKAJ DYNAMICKÝ SPREAD
                        const dynamicSpread = getDynamicSpread(price);
                        const spreadPercentageText = (dynamicSpread * 100).toFixed(1);

                        low = price * (1 - dynamicSpread);
                        high = price * (1 + dynamicSpread);
                        
                        low = Math.max(MIN_PRICE, low);
                        
                        lowThresholdInput.value = formatSkNumber(low);
                        highThresholdInput.value = formatSkNumber(high);
                        
                        saveSettings(true); // true = bez reštartu
                        
                        // Loguj dynamickú zmenu
                        logToJournal(`Automaticky nastavený ${spreadPercentageText}% limit pre ${currentCoinSymbol}.`);
                        
                        return;
                    }
                }
                
                updatePriceAxis(price, low, high, forceProportionalUpdate); 
                forceProportionalUpdate = false;
                
                const currentCoinAlarmEnabled = allCoinSettings[currentCoinSymbol]?.isAlarmSystemEnabled || false;

                /* --- Logika Alarmu --- */
                if (!globalSettings.isMasterAlarmEnabled || !currentCoinAlarmEnabled) { 
                    return;
                }

                if (isAlarmMuted) {
                    if (price > low && price < high && low > 0) {
                        isAlarmMuted = false;
                    }
                    return;
                }

                if (!isAlarmActive) {
                    const formattedPrice = formatSkNumber(price);
                    const formattedLow = formatSkNumber(low);
                    const formattedHigh = formatSkNumber(high);
                    const symbol = currentCoinSymbol;

                    if (price <= low && low > 0) {
                        triggerAlarm(`Cena (${symbol}) klesla pod limit! (Cena: ${formattedPrice}, Limit: ${formattedLow})`);
                    } else if (price >= high && high > 0) {
                        triggerAlarm(`Cena (${symbol}) stúpla nad limit! (Cena: ${formattedPrice}, Limit: ${formattedHigh})`);
                    }
                }

            } catch (error) {
                console.error("Chyba v cykle kontroly ceny:", error);
                priceDisplay.textContent = "... (Chyba)"; 
                updateMonitoringStatus('error', error.message);
                updateResetButtonText(); // Aktualizuj text aj pri chybe
                
                const lowVal = parseLocaleNumber(lowThresholdInput.value) || 0;
                const highVal = parseLocaleNumber(highThresholdInput.value) || 0;
                updatePriceAxis(currentBtcPrice || 0, lowVal, highVal, false);
            }
        }
        
        function triggerAlarm(message) {
            const currentCoinAlarmEnabled = allCoinSettings[currentCoinSymbol]?.isAlarmSystemEnabled || false;

            if (!globalSettings.isMasterAlarmEnabled || !currentCoinAlarmEnabled) return; 
            if (isAlarmActive) return; 
            
            isAlarmActive = true;
            isAlarmMuted = true;
            
            alarmMessage.textContent = message;
            alarmModal.classList.remove('hidden');
            
            const currentCoinSoundEnabled = allCoinSettings[currentCoinSymbol]?.isAlarmSoundEnabled || false;
            if (currentCoinSoundEnabled) {
                playAlarmSound(); 
            }
            
            stopMonitoring(false);
        }

        window.dismissAlarm = function() {
            isAlarmActive = false;
            alarmModal.classList.add('hidden');
            stopAlarmSound();
            
            startMonitoring();
        }

        /* --- Ovládanie Monitorovania --- */
        function startMonitoring() {
            stopMonitoring(true); 

            currentIntervalSeconds = parseInt(globalSettings.intervalSeconds);
            secondsRemaining = currentIntervalSeconds; 
            countdownTimer.textContent = `${secondsRemaining}s`;

            checkPriceAndAlert();

            priceCheckInterval = setInterval(checkPriceAndAlert, currentIntervalSeconds * 1000);
            
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function stopMonitoring(fullStop = true) {
            if (priceCheckInterval) {
                clearInterval(priceCheckInterval);
                priceCheckInterval = null;
            }
            if (fullStop && countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        function updateCountdown() {
            secondsRemaining--;
            if (secondsRemaining < 0) {
                secondsRemaining = currentIntervalSeconds - 1;
                if (secondsRemaining < 0) secondsRemaining = 0; 
            }
            countdownTimer.textContent = `${secondsRemaining}s`;
        }

        /* --- Aktualizácia UI --- */
        function updateMonitoringStatus(status, message = "") {
            switch (status) {
                case 'online':
                    statusIndicator.classList.remove('bg-gray-500', 'bg-red-500');
                    statusIndicator.classList.add('bg-green-500');
                    statusIndicator.title = "Pripojené a monitorujem";
                    break;
                case 'offline':
                    statusIndicator.classList.remove('bg-green-500', 'bg-red-500');
                    statusIndicator.classList.add('bg-gray-500');
                    statusIndicator.title = "Offline (DB nie je pripojená)";
                    break;
                case 'error':
                    statusIndicator.classList.remove('bg-gray-500', 'bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusIndicator.title = `Chyba načítania: ${message}`;
                    break;
            }
        }
        
        function forceRedrawAxis() {
            forceProportionalUpdate = true;
            
            formatInputAsSk({ target: lowThresholdInput });
            formatInputAsSk({ target: highThresholdInput });
            saveSettings(true);
            
            checkPriceAndAlert(); 
        }

        /* --- FUNKCIA "Hard Reset" (TERAZ DYNAMICKÁ) --- */
        function hardResetToPointOnePercent() {
            initializeAudio();
            if (currentBtcPrice <= 0) {
                logToJournal("Chyba: Hard Reset nie je možný, cena nie je načítaná.");
                return;
            }

            // 1. ZÍSKAJ DYNAMICKÝ SPREAD
            const dynamicSpread = getDynamicSpread(currentBtcPrice);
            const spreadPercentageText = (dynamicSpread * 100).toFixed(1);

            // 2. Vypočítaj nové hodnoty
            let newLow = currentBtcPrice * (1 - dynamicSpread);
            let newHigh = currentBtcPrice * (1 + dynamicSpread);
            newLow = Math.max(MIN_PRICE, newLow); // Ochrana

            // 3. Aktualizuj polia
            lowThresholdInput.value = formatSkNumber(newLow);
            highThresholdInput.value = formatSkNumber(newHigh);
            
            // 4. Uloží a zaloguje nové hodnoty
            saveSettings(true); 

            // 5. Okamžite prekresli os
            updatePriceAxis(currentBtcPrice, newLow, newHigh, true); // true = force proportional
            
            // 6. Pridaj explicitný log s novým percentom
            logToJournal(`Hard Reset ${spreadPercentageText}% vykonaný pre ${currentCoinSymbol}.`);
        }


        /* --- Funkcia na vykreslenie osi --- */
        function updatePriceAxis(current, low, high, forceProportional = false) {
            let p_axisMin, p_axisMax, p_axisRange;
            const mainLabelPercents = []; 
            const clamp = (val) => Math.min(100, Math.max(0, val));
            
            let effectiveCurrent = current;
            let min, max;

            /* 1. Nájdi min a max pre os */
            if (forceProportional) {
                if (low > 0 && high > 0 && high > low) {
                    min = low;
                    max = high;
                } else {
                    min = (current > 0 ? current * 0.95 : 0);
                    max = (current > 0 ? current * 1.05 : 100);
                }
                
                if (effectiveCurrent === 0) {
                     effectiveCurrent = (min + max) / 2;
                }
            } 
            else {
                if (low > 0 && high > 0 && high > low) {
                    min = low;
                    max = high;
                    if (effectiveCurrent === 0) {
                         effectiveCurrent = (low + high) / 2;
                    }
                    
                    const isOutside = (effectiveCurrent < min || effectiveCurrent > max);
                    const currentAxisRange = axisMax - axisMin;
                    const thresholdRange = max - min;
                    
                    if (isOutside || (thresholdRange / currentAxisRange < 0.3 && currentAxisRange > 0) ) {
                        min = Math.min(min, effectiveCurrent);
                        max = Math.max(max, effectiveCurrent);
                    }

                } else if (effectiveCurrent > 0) {
                    min = effectiveCurrent * 0.95;
                    max = effectiveCurrent * 1.05;
                } else {
                    min = 0; 
                    max = 100;
                    effectiveCurrent = 50;
                }
            }

            /* 2. Pridaj padding */
            let range = Math.max(max - min, 0);
            if (range <= 0) {
                range = (effectiveCurrent > 0) ? effectiveCurrent * 0.2 : 100;
            }
            
            const padding = range * 0.15;
            
            p_axisMin = Math.max(0, min - padding); 
            p_axisMax = max + padding;
            p_axisRange = p_axisMax - p_axisMin;
            
            if (p_axisRange <= 0) p_axisRange = 1; 

            /* 3. Vypočítaj percentá */
            const currentPercent = ((effectiveCurrent - p_axisMin) / p_axisRange) * 100;
            const lowPercent = ((low - p_axisMin) / p_axisRange) * 100;
            const highPercent = ((high - p_axisMin) / p_axisRange) * 100;
            
            if (current > 0) mainLabelPercents.push(currentPercent);
            if (low > 0) mainLabelPercents.push(lowPercent);
            if (high > 0) mainLabelPercents.push(highPercent);

            /* 4. Aktualizuj pozície a viditeľnosť */
            const deltaLow = (current > 0 && low > 0) ? current - low : 0;
            const deltaHigh = (current > 0 && high > 0) ? high - current : 0;

            if (current > 0) {
                document.getElementById('current-dot').style.bottom = `${clamp(currentPercent)}%`;
                document.getElementById('current-label').style.bottom = `${clamp(currentPercent)}%`;
                document.getElementById('current-label').textContent = `CENA: ${formatSkNumber(current)}`;
                document.getElementById('current-dot').classList.remove('hidden');
                document.getElementById('current-label').classList.remove('hidden');
            } else {
                document.getElementById('current-dot').classList.add('hidden');
                document.getElementById('current-label').classList.add('hidden');
            }
            
            document.getElementById('low-dot').style.bottom = `${clamp(lowPercent)}%`;
            document.getElementById('low-label').style.bottom = `${clamp(lowPercent)}%`;
            const deltaLowText = (deltaLow > 0) ? ` (-${skDeltaFormatter.format(deltaLow)})` : ` (+${skDeltaFormatter.format(Math.abs(deltaLow))})`;
            if (low <= 0) {
                 document.getElementById('low-label').textContent = `LOW: ${formatSkNumber(low)}`;
            } else {
                 document.getElementById('low-label').textContent = `LOW: ${formatSkNumber(low)}${deltaLowText}`;
            }
            document.getElementById('low-dot').classList.remove('hidden');
            document.getElementById('low-label').classList.remove('hidden');

            document.getElementById('high-dot').style.bottom = `${clamp(highPercent)}%`;
            document.getElementById('high-label').style.bottom = `${clamp(highPercent)}%`;
            const deltaHighText = (deltaHigh > 0) ? ` (+${skDeltaFormatter.format(deltaHigh)})` : ` (-${skDeltaFormatter.format(Math.abs(deltaHigh))})`;
            if (high <= 0) {
                 document.getElementById('high-label').textContent = `HIGH: ${formatSkNumber(high)}`;
            } else {
                 document.getElementById('high-label').textContent = `HIGH: ${formatSkNumber(high)}${deltaHighText}`;
            }
            document.getElementById('high-dot').classList.remove('hidden');
            document.getElementById('high-label').classList.remove('hidden');
            

            /* 5. Ulož globálne pre D&D a Grid */
            axisMin = p_axisMin;
            axisMax = p_axisMax;
            axisRange = p_axisRange;
            
            updateAxisGrid(axisMin, axisMax, axisRange, mainLabelPercents);
        }

        function updateAxisGrid(p_axisMin, p_axisMax, p_axisRange, mainLabelPercents) {
            gridLinesContainer.innerHTML = '';
            const numLines = 5;
            if (p_axisRange <= 0 || isNaN(p_axisRange)) return; 
            
            const step = p_axisRange / (numLines - 1);

            for (let i = 0; i < numLines; i++) {
                const price = Math.max(0, p_axisMin + (i * step));
                const percent = (i / (numLines - 1)) * 100;

                let collision = false;
                for (const mainPercent of mainLabelPercents) {
                    if (!isNaN(mainPercent) && Math.abs(percent - mainPercent) < 7) {
                        collision = true;
                        break;
                    }
                }

                if (!collision) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'axis-grid-item';
                    itemEl.style.bottom = `${percent}%`;
                    
                    const labelEl = document.createElement('span');
                    labelEl.className = 'axis-grid-label-text';
                    labelEl.textContent = formatSkNumber(price);

                    itemEl.appendChild(labelEl); 
                    gridLinesContainer.appendChild(itemEl);
                }
            }
        }

        /* --- Prepínače --- */
        function updateMasterAlarmStatus(doSave = true) {
            if (doSave) {
                globalSettings.isMasterAlarmEnabled = !globalSettings.isMasterAlarmEnabled;
                initializeAudio(); 
            }
            
            if (globalSettings.isMasterAlarmEnabled) {
                masterAlarmToggle.classList.add('toggled'); 
                masterAlarmToggle.setAttribute('aria-checked', 'true');
            } else {
                masterAlarmToggle.classList.remove('toggled'); 
                masterAlarmToggle.setAttribute('aria-checked', 'false');
                
                if (isAlarmActive) {
                    dismissAlarm();
                }
            }

            if (doSave) {
                saveGlobalSettingsOnly();
            }
        }

        function updateAlarmSystemStatus(doSave = true, explicitState = null) {
            let currentState = false;

            if (allCoinSettings[currentCoinSymbol]) {
                currentState = allCoinSettings[currentCoinSymbol].isAlarmSystemEnabled || false;
            }

            let newState;
            if (explicitState !== null) {
                newState = explicitState;
            } else {
                newState = !currentState;
                initializeAudio();
            }

            if (!allCoinSettings[currentCoinSymbol]) {
                allCoinSettings[currentCoinSymbol] = {};
            }
            allCoinSettings[currentCoinSymbol].isAlarmSystemEnabled = newState;
            
            if (newState) {
                alarmEnabledToggle.classList.add('toggled'); 
                alarmEnabledToggle.setAttribute('aria-checked', 'true');
            } else {
                alarmEnabledToggle.classList.remove('toggled'); 
                alarmEnabledToggle.setAttribute('aria-checked', 'false');
                
                if (isAlarmActive) {
                    dismissAlarm();
                }
            }

            if (doSave) {
                saveSettings(true);
            }
        }
        
        function updateAlarmSoundStatus(doSave = true, explicitState = null) {
            let currentState = false;

            if (allCoinSettings[currentCoinSymbol]) {
                currentState = allCoinSettings[currentCoinSymbol].isAlarmSoundEnabled || false;
            }

            let newState;
            if (explicitState !== null) {
                newState = explicitState;
            } else {
                newState = !currentState;
                initializeAudio();
            }

            if (!allCoinSettings[currentCoinSymbol]) {
                allCoinSettings[currentCoinSymbol] = {};
            }
            allCoinSettings[currentCoinSymbol].isAlarmSoundEnabled = newState;
            
            if (newState) {
                alarmSoundToggle.classList.add('toggled'); 
                alarmSoundToggle.setAttribute('aria-checked', 'true');
            } else {
                alarmSoundToggle.classList.remove('toggled'); 
                alarmSoundToggle.setAttribute('aria-checked', 'false');
            }

            if (doSave) {
                saveSettings(true);
            }
        }

        /* --- Formátovanie Inputov (Live) --- */
        function formatInputAsSk(e) {
            const input = e.target;
            let value = input.value;
            if (value.endsWith(',') || value.endsWith('.')) return;

            let numValue = parseLocaleNumber(value);
            
            if (input.id === 'low-threshold' && !isNaN(numValue) && numValue < MIN_PRICE) {
                numValue = MIN_PRICE;
            }

            if (!isNaN(numValue)) {
                input.value = formatSkNumber(numValue);
            } else if (value !== "") {
                let lastValid = parseLocaleNumber(input.dataset.lastValid || '0');
                if (input.id === 'low-threshold' && lastValid < MIN_PRICE) lastValid = MIN_PRICE;
                input.value = formatSkNumber(lastValid);
            } else {
                 input.dataset.lastValid = '';
            }
            
            if (!isNaN(numValue)) {
                 input.dataset.lastValid = numValue;
            }
        }

        function storeLastValid(e) {
             const numValue = parseLocaleNumber(e.target.value);
             if (!isNaN(numValue)) {
                 e.target.dataset.lastValid = numValue;
             }
        }

        /* --- Event Listeners --- */
        saveButton.addEventListener('click', () => {
            initializeAudio(); 
            
            formatInputAsSk({ target: lowThresholdInput });
            formatInputAsSk({ target: highThresholdInput });
            
            saveSettings(false);
        });
        
        recenterButton.addEventListener('click', () => {
            initializeAudio(); 
            forceRedrawAxis(); 
        });

        hardResetButton.addEventListener('click', hardResetToPointOnePercent);

        masterAlarmToggle.addEventListener('click', () => {
            updateMasterAlarmStatus(true);
        });

        alarmEnabledToggle.addEventListener('click', () => {
            updateAlarmSystemStatus(true); 
        });
        
        alarmSoundToggle.addEventListener('click', () => {
            updateAlarmSoundStatus(true); 
        });

        intervalSlider.addEventListener('input', (e) => {
            intervalValue.textContent = `${e.target.value}s`;
            globalSettings.intervalSeconds = parseInt(e.target.value);
        });
        
        lowThresholdInput.addEventListener('blur', formatInputAsSk);
        highThresholdInput.addEventListener('blur', formatInputAsSk);
        lowThresholdInput.addEventListener('focus', storeLastValid);
        highThresholdInput.addEventListener('focus', storeLastValid);
        
        /* --- D&D Listeners --- */
        function handleDragStart(e, type) {
            e.preventDefault();
            initializeAudio(); 
            
            if (isNaN(axisRange) || axisRange <= 0) {
                console.warn("Os nie je pripravená na D&D.");
                return; 
            }

            isDragging = type;
            axisRect = document.querySelector('.price-axis-container').getBoundingClientRect();
            document.body.style.cursor = 'ns-resize'; 
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false }); 
            document.addEventListener('touchend', handleDragEnd); 
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if (!clientY) return;

            if (currentBtcPrice <= 0) {
                 console.warn("D&D pozastavené, čaká sa na cenu.");
                 return;
            }

            e.preventDefault(); 

            if (!axisRect) axisRect = document.querySelector('.price-axis-container').getBoundingClientRect();
            
            const relativeY = clientY - axisRect.top;
            let percent = 100 - (relativeY / axisRect.height) * 100; 
            percent = Math.min(100, Math.max(0, percent)); 

            if (axisRange <= 0 || isNaN(axisRange)) return; 
            let newPrice = axisMin + (percent / 100) * axisRange;

            if (isDragging === 'low') {
                if (newPrice >= currentBtcPrice) {
                    newPrice = currentBtcPrice;
                }
                newPrice = Math.max(MIN_PRICE, newPrice); 
                lowThresholdInput.value = formatSkNumber(newPrice);
            } else if (isDragging === 'high') {
                if (newPrice <= currentBtcPrice) {
                    newPrice = currentBtcPrice;
                }
                highThresholdInput.value = formatSkNumber(newPrice);
            }
            
            const lowVal = parseLocaleNumber(lowThresholdInput.value) || 0;
            const highVal = parseLocaleNumber(highThresholdInput.value) || 0;
            updatePriceAxis(currentBtcPrice, lowVal, highVal);
        }

        function handleDragEnd() {
            if (!isDragging) return;
            isDragging = null;
            document.body.style.cursor = 'default'; 
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
            document.removeEventListener('touchmove', handleDragMove);
            document.removeEventListener('touchend', handleDragEnd);
            
            formatInputAsSk({ target: lowThresholdInput });
            formatInputAsSk({ target: highThresholdInput });

            saveSettings(true);
        }
        
        document.getElementById('low-label').addEventListener('mousedown', (e) => handleDragStart(e, 'low'));
        document.getElementById('low-label').addEventListener('touchstart', (e) => handleDragStart(e, 'low'));
        document.getElementById('high-label').addEventListener('mousedown', (e) => handleDragStart(e, 'high'));
        document.getElementById('high-label').addEventListener('touchstart', (e) => handleDragStart(e, 'high'));
        
        addFavoriteButton.addEventListener('click', addFavorite);

        coinSymbolInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addFavorite();
            }
        });

        /* --- Spustenie aplikácie --- */
        initialize();

    </script>
</body>
</html>
